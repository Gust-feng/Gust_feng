# Wireshark 学习笔记 — 数据包信息窗口解析

---

## 1. 抓包与层级概览

* Wireshark 按照协议栈显示：以太网（链路层） → IP（网络层） → UDP/TCP（传输层） → 应用层（如 DNS、HTTP 等）。
* 每个捕获的单元称为一个**帧**。帧编号从 1 开始，按捕获时间顺序递增；使用过滤器不会改变帧的原始编号。
* Wireshark 在不同协议层维护独立的流编号（如 `ip.stream`、`udp.stream`、`tcp.stream`），可用于追踪完整的通信会话。

---

## 2. 数据链路层（以太网）要点

* 以太网第二版显示源 MAC 地址、目的 MAC 地址和类型字段（例如：IPv4 对应 0x0800）。
* MAC 地址前 3 字节通常表示厂商标识，MAC 地址的最低位包含两个控制位：
  * **单播/组播位**：表明是否为组播或广播地址（1 表示组播或广播）
  * **全局/本地位**：表明地址是厂商分配还是本地管理员修改（1 表示本地管理员分配）
* 局域网常见的广播地址：`ff:ff:ff:ff:ff:ff`，在 ARP 广播等场景会使用。
* 在虚拟机中可以修改 MAC 地址（伪装），修改后本地管理位通常会被置为 1。

---

## 3. 地址解析协议（ARP）

* ARP 用于在链路层将目标 IP 地址映射为 MAC 地址。典型格式："谁有这个 IP？请告诉我（发送者的 IP）"。
* ARP 请求通常是广播，目标 MAC 为空（00:00:00:00:00:00）或广播地址；ARP 回应是单播。
* **ARP 探测**：用于 DHCP 客户端自检（检测 DHCP 分配的 IP 是否已被占用），发送时发送者 IP 为 0.0.0.0，目标 IP 为待检测的 IP。
* 在 Wireshark 中的检测方法：使用 `arp` 过滤器，查找同一 IP 被不同 MAC 地址宣称，或频繁的无故 ARP 通告。

---

## 4. 动态主机配置（DHCP）与地址获取流程

* 常见流程：发现 → 提供 → 请求 → 确认（四步握手）。
* 当客户端没有 IP 时，源 IP 为 0.0.0.0，目的为广播地址 255.255.255.255，UDP 端口从 68 到 67。
* **DHCP 保留地址**（路由器端静态分配）：路由器根据 MAC 地址分配指定 IP（仍通过 DHCP 流程）；客户端本地静态 IP 则会绕过 DHCP。
* 客户端获得 DHCP 地址后会执行 ARP 探测，以确认该地址无冲突。

---

## 5. IPv4 报头字段（常见项）

* **版本号**：固定为 4。
* **头部长度**：以 4 字节为单位计数。标准头部长度为 5，即 20 字节。
* **服务类型字段**：包含 6 位差分服务和 2 位显式拥塞通知。差分服务用于服务质量标记；拥塞通知用于网络拥塞控制（默认为 00，表示不支持）。
* **总长度**：IP 数据包（头部 + 数据）的总字节数。
* **标识符**：16 位，用于数据包分片重组（同一原始数据包的所有分片共享相同标识）。
* **标志位**（3 位）和**片偏移**（13 位）：控制数据包分片。
  * **禁止分片位**：不允许对数据包分片。
  * **更多分片位**：1 表示后面还有分片，0 表示最后一片或未分片。
  * **片偏移**：单位为 8 字节（偏移值 × 8 = 实际字节偏移量）。
* **生存时间**：每经过一个路由器减 1，到 0 则丢弃并返回 ICMP 错误消息。
* **协议号**：上层协议编号（UDP 为 17，TCP 为 6，ICMP 为 1）。
* **头部校验和**：仅对 IP 头部进行校验（Wireshark 默认可能不验证，取决于设置与网卡卸载功能）。
* **源地址 / 目的地址**：发送方和接收方的 IP 地址。

---

## 6. IP 分片与重组

* 当数据大小超过链路最大传输单元时，IP 层会将数据分片发送。每个分片带有相同的标识符。
* 片偏移指定该分片在原始数据中的起始位置，单位为 8 字节（例如偏移=185 表示从第 1480 字节开始）。
* 更多分片位=1 表示后面还有分片；更多分片位=0 表示这是最后一片或数据未分片。
* 当禁止分片位=1 且数据长度超过最大传输单元时，路由器会返回 ICMP "需要分片" 错误消息（用于路径最大传输单元发现）。

---

## 7. 传输层：UDP 主要字段

* UDP 头部占 8 字节：源端口（2 字节）、目的端口（2 字节）、长度（2 字节）、校验和（2 字节）。
* DNS 常用 UDP 端口：客户端临时端口 → 服务器 53 端口；响应从 53 端口 → 客户端端口。
* 长度 = UDP 头部 + 数据负载。Wireshark 显示为"UDP 负载（N 字节）"。
* 校验和可能显示为"未验证"（网卡卸载功能影响校验结果）。
* Wireshark 为每个 UDP/TCP 会话分配流标识（`udp.stream` / `tcp.stream`），可用于过滤（例如 `udp.stream eq 3`）。

---

## 8. 域名系统（DNS）- 请求与响应字段

* **事务标识**：用于匹配请求与响应。客户端发出查询时包含该标识，服务器响应时原样返回。
* **标志位**（16 位）：包含多个控制位。
  * **查询/响应位**：0 表示查询，1 表示响应
  * **操作码**：操作类型（0 表示标准查询）
  * **期望递归位**：客户端请求服务器进行递归查询
  * **支持递归位**：服务器是否支持递归查询
  * **权威应答位**：服务器是否为该域的权威服务器
  * **截断位**：响应是否因过长被截断
  * **返回码**：查询结果状态（0 表示无错误）
* **问题数 / 回答数 / 权威记录数 / 附加记录数**：分别表示各个段的记录数量。
* **查询项**：包含域名、记录类型（A/AAAA/CNAME 等）、类（通常为 IN，表示互联网）。
* **应答项**：可能包含别名链和最终的 A/AAAA 记录；包含生存时间（缓存时间）、数据长度和返回值。
* Wireshark 上常见提示：`[响应在帧: <帧号>]` 和 `[请求在帧: <帧号>]`，这是通过事务标识匹配后添加的引用；这些引用在对应响应到达之前不存在。

---

## 9. Wireshark 使用要点与常用过滤器

* 帧编号是原始捕获序列，不会随过滤器改变。
* 常用显示过滤器示例：
  * 查看 ARP 数据包：`arp`
  * 查看声称某个 IP 的 ARP：`arp.src.proto_ipv4 == 192.168.31.1`（替换为实际 IP）
  * 查看 DNS 数据包：`dns`
  * 仅显示与本机相关的 DNS：`ip.addr == <你的IP> && udp.port == 53`
  * 按 UDP 会话过滤：`udp.stream == 3`
  * 查找 ARP 回复（操作码=2）：`arp.opcode == 2`

---

## 10. 排查与分析步骤（示例流程）

1. 确认问题范围：主机不通、网页被重定向、只影响特定域名等。
2. 抓包时包含链路层（以太网）以便观察 ARP 和 MAC 地址。
3. 使用 `arp` 过滤器检查网关 MAC 地址是否异常变动。
4. 使用 `dns` 过滤器检查请求/响应的事务标识、来源 IP、返回值是否异常。
5. 通过 `udp.stream` 来跟踪完整的请求-响应序列，并使用时间戳测量延迟。
6. 若怀疑 ARP 欺骗，收集证据：频繁的无故 ARP 通告、同一 IP 被不同 MAC 地址宣称、异常端口的 MAC 地址表。

---

## 11. 安全相关（ARP 欺骗与 DNS 劫持）

* 局域网内存在 ARP 欺骗导致 DNS 劫持的可能性：攻击者可通过伪造 ARP，将网关 IP 对应到自己的 MAC 地址，从而拦截或伪造 DNS 流量（中间人攻击）。
* 更可靠的防护在交换机层面：DHCP 监听、动态 ARP 检测、端口安全、VLAN 隔离。终端安全软件（如杀毒软件）可提供检测与阻断告警，但不能替代交换机的二层防护机制。
* 客户端防护建议：
  * 启用加密 DNS（DNS over HTTPS 或 DNS over TLS）
  * 使用 HTTPS 访问网站
  * 使用 VPN 加密通信
  * 保持终端安全软件的网络保护模块启用
  * 定期查看 ARP 缓存与安全日志

---

